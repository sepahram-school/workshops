---
x-image: &image
  # image: ${RW_IMAGE:-docker.arvancloud.ir/risingwavelabs/risingwave:v2.5.1}
  image: ${RW_IMAGE:-docker.arvancloud.ir/risingwavelabs/risingwave:v2.8.0-alpha.20251230}

networks:
  sepahram-network:
    driver: bridge
services:
  risingwave-standalone:
    <<: *image
    command: "standalone --meta-opts=\" \
                    --listen-addr 0.0.0.0:5690 \
                    --advertise-addr 0.0.0.0:5690 \
                    --dashboard-host 0.0.0.0:5691 \
                    --prometheus-host 0.0.0.0:1250 \
                    --prometheus-endpoint http://prometheus-0:9500 \
                    --backend sql \
                    --sql-endpoint postgres://postgres:@postgres-0:5432/metadata \
                    --state-store hummock+s3://hummock001 \
                    --data-directory hummock_001 \
                    --config-path /risingwave.toml\" \
                 --compute-opts=\" \
                    --config-path /risingwave.toml \
                    --listen-addr 0.0.0.0:5688 \
                    --prometheus-listener-addr 0.0.0.0:1250 \
                    --advertise-addr 0.0.0.0:5688 \
                    --async-stack-trace verbose \
                    --parallelism 4 \
                    --total-memory-bytes 4294967296 \
                    --meta-address http://0.0.0.0:5690 \
                    --memory-manager-target-bytes 3221225472 \" \
                 --frontend-opts=\" \
                   --config-path /risingwave.toml \
                   --listen-addr 0.0.0.0:4566 \
                   --advertise-addr 0.0.0.0:4566 \
                   --prometheus-listener-addr 0.0.0.0:1250 \
                   --health-check-listener-addr 0.0.0.0:6786 \
                   --meta-addr http://0.0.0.0:5690 \
                   --frontend-total-memory-bytes=4294967296\" \
                 --compactor-opts=\" \
                   --listen-addr 0.0.0.0:6660 \
                   --prometheus-listener-addr 0.0.0.0:1250 \
                   --advertise-addr 0.0.0.0:6660 \
                   --meta-address http://0.0.0.0:5690 \
                   --compactor-total-memory-bytes=4294967296\""
    expose:
      - "6660"
      - "4566"
      - "5688"
      - "5690"
      - "1250"
      - "5691"
    ports:
      - "4566:4566"
      - "5690:5690"
      - "5691:5691"
      - "1250:1250"
    depends_on:
      postgres-0:
        condition: service_healthy
      rustfs:
        condition: service_healthy
      rustfs-bucket-init:
        condition: service_completed_successfully
    volumes:
      - "./risingwave.toml:/risingwave.toml"
    environment:
      RUST_BACKTRACE: "1"
      ENABLE_TELEMETRY: ${ENABLE_TELEMETRY:-true}
      RW_TELEMETRY_TYPE: ${RW_TELEMETRY_TYPE:-"docker-compose"}
      RW_SECRET_STORE_PRIVATE_KEY_HEX: ${RW_SECRET_STORE_PRIVATE_KEY_HEX:-0123456789abcdef0123456789abcdef}
      RW_LICENSE_KEY: ${RW_LICENSE_KEY:-}
      # S3-compatible storage configuration using rustfs
      AWS_REGION: "us-east-1"
      AWS_ACCESS_KEY_ID: "admin"
      AWS_SECRET_ACCESS_KEY: "admin"
      # Use HTTP endpoint without https://
      RW_S3_ENDPOINT: "http://rustfs:9000"
      # Force these settings for local S3-compatible storage
      RW_IS_FORCE_PATH_STYLE: "true"
      RW_ENABLE_HTTPS: "false"
    container_name: risingwave-standalone
    healthcheck:
      test:
        - CMD-SHELL
        - bash -c 'printf \"GET / HTTP/1.1\n\n\" > /dev/tcp/127.0.0.1/6660; exit $$?;'
        - bash -c 'printf \"GET / HTTP/1.1\n\n\" > /dev/tcp/127.0.0.1/5688; exit $$?;'
        - bash -c '> /dev/tcp/127.0.0.1/4566; exit $$?;'
        - bash -c 'printf \"GET / HTTP/1.1\n\n\" > /dev/tcp/127.0.0.1/5690; exit $$?;'
      interval: 1s
      timeout: 5s
    restart: always
    deploy:
      resources:
        limits:
          memory: 28G
        reservations:
          memory: 28G
    networks:
      - sepahram-network

  postgres-0:
    image: "docker.arvancloud.ir/postgres:15-alpine"
    container_name: postgres_rw
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
      - POSTGRES_USER=postgres
      - POSTGRES_DB=metadata
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    expose:
      - "5432"
    ports:
      - "8432:5432"
    volumes:
      - "postgres-0:/var/lib/postgresql/data"
    depends_on:
      volume-permission-helper:
        condition: service_completed_successfully
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 2s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - sepahram-network

  grafana-0:
    image: "docker.arvancloud.ir/grafana/grafana-oss:latest"
    command: [ ]
    expose:
      - "3001"
    ports:
      - "3001:3001"
    depends_on:
      prometheus-0:
        condition: service_healthy
      volume-permission-helper:
        condition: service_completed_successfully
    volumes:
      - "grafana-0:/var/lib/grafana"
      - "./grafana/grafana.ini:/etc/grafana/grafana.ini"
      - "./grafana/grafana-risedev-datasource.yml:/etc/grafana/provisioning/datasources/grafana-risedev-datasource.yml"
      - "./grafana/grafana-risedev-dashboard.yml:/etc/grafana/provisioning/dashboards/grafana-risedev-dashboard.yml"
      - "./dashboards:/dashboards"
    environment: {}
    container_name: grafana-0
    healthcheck:
      test:
        - CMD-SHELL
        - bash -c 'printf \"GET / HTTP/1.1\n\n\" > /dev/tcp/127.0.0.1/3001; exit $$?;'
      interval: 1s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - sepahram-network

  prometheus-0:
    image: "docker.arvancloud.ir/prom/prometheus:latest"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.listen-address=0.0.0.0:9500"
      - "--storage.tsdb.retention.time=30d"
    expose:
      - "9500"
    ports:
      - "9500:9500"
    depends_on:
      volume-permission-helper:
        condition: service_completed_successfully
    volumes:
      - "prometheus-0:/prometheus"
      - "./prometheus.yaml:/etc/prometheus/prometheus.yml"
    environment: {}
    container_name: prometheus-0
    healthcheck:
      test:
        - CMD-SHELL
        - sh -c 'printf "GET /-/healthy HTTP/1.0\n\n" | nc localhost 9500; exit $$?;'
      interval: 1s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - sepahram-network

  message_queue:
    image: "docker.arvancloud.ir/redpandadata/redpanda:latest"
    command:
      - redpanda
      - start
      - "--smp"
      - "1"
      - "--reserve-memory"
      - 0M
      - "--memory"
      - 4G
      - "--overprovisioned"
      - "--node-id"
      - "0"
      - "--check=false"
      - "--kafka-addr"
      - "PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092"
      - "--advertise-kafka-addr"
      - "PLAINTEXT://message_queue:29092,OUTSIDE://localhost:9092"
    expose:
      - "29092"
      - "9092"
      - "9644"
    ports:
      - "29092:29092"
      - "9092:9092"
      - "9644:9644"
      - "8081:8081"
    depends_on:
      volume-permission-helper:
        condition: service_completed_successfully
    volumes:
      - "message_queue:/var/lib/redpanda/data"
    environment: {}
    container_name: message_queue
    healthcheck:
      test: curl -f localhost:9644/v1/status/ready
      interval: 1s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - sepahram-network

  rustfs:
    image: docker.arvancloud.ir/rustfs/rustfs:latest
    container_name: rustfs-server
    security_opt:
      - "no-new-privileges:true"
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    ports:
      - "9000:9000" # S3 API port
      - "9001:9001" # Console port
    environment:
      - RUSTFS_VOLUMES=/data/rustfs{0...3}
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_EXTERNAL_ADDRESS=:9000
      - RUSTFS_CORS_ALLOWED_ORIGINS=*
      - RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS=*
      - RUSTFS_ACCESS_KEY=admin
      - RUSTFS_SECRET_KEY=admin
      - RUSTFS_OBS_LOGGER_LEVEL=info
      - RUSTFS_TLS_PATH=/opt/tls
      # Object Cache
      - RUSTFS_OBJECT_CACHE_ENABLE=true
      - RUSTFS_OBJECT_CACHE_TTL_SECS=300
    volumes:
      - rustfs_data_0:/data/rustfs0
      - rustfs_data_1:/data/rustfs1
      - rustfs_data_2:/data/rustfs2
      - rustfs_data_3:/data/rustfs3
      - logs:/app/logs
    depends_on:
      volume-permission-helper:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "sh", "-c",
          "curl -f http://localhost:9000/health && curl -f http://localhost:9001/rustfs/console/health"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - sepahram-network

  volume-permission-helper:
    container_name: risingwave-volume-permission-helper
    image: docker.arvancloud.ir/library/alpine
    volumes:
      - rustfs_data_0:/data0
      - rustfs_data_1:/data1
      - rustfs_data_2:/data2
      - rustfs_data_3:/data3
      - logs:/logs
    command: >
      sh -c "
        chown -R 10001:10001 /data0 /data1 /data2 /data3 /logs &&
        echo 'Volume Permissions fixed' &&
        exit 0
      "
    restart: "no"
    networks:
      - sepahram-network

  rustfs-bucket-init:
    container_name: risingwave-rustfs-bucket-init
    image: docker.arvancloud.ir/amazon/aws-cli:latest
    depends_on:
      rustfs:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: admin
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for rustfs to be ready...';
      sleep 5;
      echo 'Creating bucket hummock001...';
      aws --endpoint-url http://rustfs:9000 s3 mb s3://hummock001 || echo 'Bucket may already exist';
      echo 'Verifying bucket exists...';
      aws --endpoint-url http://rustfs:9000 s3 ls s3://hummock001 && echo 'Bucket hummock001 is ready!' || echo 'Warning: Could not verify bucket';
      exit 0;
      "
    restart: "no"
    networks:
      - sepahram-network

  console:
    container_name: redpanda-console
    image: docker.arvancloud.ir/redpandadata/console:latest
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["message_queue:29092"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://message_queue:9644"]
    ports:
      - 9100:8080
    depends_on:
      - message_queue
    restart: always
    networks:
      - sepahram-network

  clickhouse:
    image: docker.arvancloud.ir/clickhouse/clickhouse-server:latest
    container_name: clickhouse
    hostname: clickhouse
    profiles:
      - external-sources
    ports:
      - "8123:8123"   # HTTP interface
      - "9002:9000"   # Native TCP interface (changed to avoid conflict)
    environment:
      CLICKHOUSE_DB: analytics
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    ulimits:            # important for high-load setups
      nofile:
        soft: 262144
        hard: 262144
    depends_on:
      volume-permission-helper:
        condition: service_completed_successfully
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8123/ping | grep -q 'Ok.'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sepahram-network

  risingwave-console:
    image: docker.arvancloud.ir/risingwavelabs/risingwave-console:v0.5.2
    container_name: risingwave-console
    ports:
      - "8020:8020"
    environment:
      RCONSOLE_SERVER_PG_DSN: postgres://postgres:postgres@postgres-0:5432/postgres
      RCONSOLE_SERVER_PORT: 8020
      RCONSOLE_SERVER_DEBUG_ENABLE: true
      RCONSOLE_SERVER_DEBUG_PORT: 8777
      RCONSOLE_ROOT_PASSWORD: '123456'
      RCONSOLE_INIT: /risingwave-console-data/init.yaml
      RCONSOLE_RISECTLDIR: /risingwave-console-data/risectl
      RCONSOLE_METRICSPORT: 9020
    volumes:
      - ./dev:/risingwave-console-data
    depends_on:
      - risingwave-standalone
      - postgres-0
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8020/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - sepahram-network


  postgres-external:
    image: docker.arvancloud.ir/library/postgres:17
    container_name: postgres-external
    hostname: postgres-external
    volumes:
      - pg_data:/var/lib/postgresql
    ports:
      - '5432:5432'
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: external_db
    command: [ 'postgres', '-c', 'wal_level=logical' ]
    healthcheck:
      test: [ 'CMD', 'psql', '-U', 'postgres', '-c', 'SELECT 1' ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sepahram-network
    restart: always
    profiles:
      - external-sources

volumes:
  postgres-0:
    external: false
  grafana-0:
    external: false
  prometheus-0:
    external: false
  message_queue:
    external: false
  rustfs_data_0:
    external: false
  rustfs_data_1:
    external: false
  rustfs_data_2:
    external: false
  rustfs_data_3:
    external: false
  logs:
    external: false
  clickhouse_data:
    external: false
  clickhouse_logs:
    external: false
  pg_data:
    external: false
